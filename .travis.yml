language: java
sudo: false

env:
  global:
    - RACKET_DIR=~/racket 
    - Z3_DIR=~/z3
    - RACKET_VERSION="http://www.eecs.northwestern.edu/racket/6.2.1/racket-6.2.1-x86_64-linux-ubuntu-precise.sh"

before_install:
  - curl -L -o racket.sh $RACKET_VERSION

install:
  - sh ./racket.sh --in-place --dest $RACKET_DIR
  - if [[ ! -e "$Z3_DIR/build/z3" ]]; then
      rm -rf $Z3_DIR;
      git clone https://github.com/z3prover/z3.git $Z3_DIR;
      cd $Z3_DIR;
      python scripts/mk_make.py;
      cd $Z3_DIR/build;
      make -j2;
      cd $TRAVIS_BUILD_DIR;
    else echo "using z3 from cache"; fi
  - cp $Z3_DIR/build/z3 bin/

script:
  - ~/racket/bin/raco link rosette
  - ~/racket/bin/raco setup -l rosette
  - grep -o "(run-test \".*\.rkt\")" test/all-tests.rkt |
    sed "s/(run-test \"//" |
    sed "s/\")//" |
    sed "s/^/test\//" |
    uniq |
    xargs ~/racket/bin/raco test -t

cache:
  directories:
    - $Z3_DIR
